<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DSP æ·±åº¦äº¤äº’è¯¾ç¨‹ï¼šçº¿æ€§ç›¸ä½ (Linear Phase)</title>
    
    <!-- MathJax é…ç½® -->
    <script>
    window.MathJax = {
      tex: { inlineMath: [['$', '$'], ['\\(', '\\)']], displayMath: [['$$', '$$']] },
      svg: { fontCache: 'global' },
      startup: { typeset: true }
    };
    </script>
    <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>

    <style>
        :root {
            --primary: #2c3e50;
            --secondary: #2980b9;
            --accent-linear: #27ae60;
            --accent-nonlinear: #c0392b;
            --bg: #f4f6f7;
            --text: #333;
        }

        body {
            font-family: "Segoe UI", "Microsoft YaHei", sans-serif;
            background-color: var(--bg);
            color: var(--text);
            margin: 0;
            padding: 0;
            line-height: 1.6;
        }

        .container { max-width: 1100px; margin: 0 auto; padding: 20px; }

        header {
            background: linear-gradient(135deg, #2c3e50, #3498db);
            color: white;
            padding: 40px 20px;
            text-align: center;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
            margin-bottom: 30px;
        }
        h1 { margin: 0; font-size: 2.2rem; }
        .subtitle { margin-top: 10px; opacity: 0.9; font-size: 1.1rem; }

        .card {
            background: white;
            border-radius: 10px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 3px 10px rgba(0,0,0,0.05);
            border-left: 5px solid var(--secondary);
        }

        h2 { color: var(--secondary); border-bottom: 1px solid #eee; padding-bottom: 10px; margin-top: 0; }
        
        /* Math Block */
        .math-block {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            border: 1px solid #e0e0e0;
            overflow-x: auto;
        }

        /* äº¤äº’åŒºåŸŸå¸ƒå±€ */
        .lab-container {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            margin-top: 20px;
        }
        .lab-visual { flex: 2; min-width: 300px; }
        .lab-controls { 
            flex: 1; min-width: 250px; 
            background: #fafafa; 
            padding: 20px; 
            border-radius: 8px; 
            border: 1px solid #eee;
            display: flex; 
            flex-direction: column; 
            justify-content: center;
        }

        /* Canvas */
        canvas {
            width: 100%;
            background: #fff;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-shadow: inset 0 0 5px rgba(0,0,0,0.02);
        }

        /* Buttons & Inputs */
        button {
            width: 100%;
            padding: 12px;
            margin: 8px 0;
            border: none;
            border-radius: 6px;
            font-size: 1rem;
            cursor: pointer;
            font-weight: bold;
            transition: transform 0.1s;
        }
        button:active { transform: scale(0.98); }
        
        .btn-toggle { background: var(--secondary); color: white; }
        .btn-linear { background: var(--accent-linear); color: white; }
        .btn-nonlinear { background: var(--accent-nonlinear); color: white; }
        .btn-reset { background: #7f8c8d; color: white; }

        input[type=range] { width: 100%; margin: 10px 0; cursor: pointer; }
        
        .status-badge {
            display: inline-block;
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 0.85rem;
            color: white;
            font-weight: bold;
            margin-bottom: 10px;
        }
        .badge-linear { background-color: var(--accent-linear); }
        .badge-nonlinear { background-color: var(--accent-nonlinear); }
    </style>
</head>
<body>

<header>
    <h1>DSP æ·±åº¦äº¤äº’è¯¾ç¨‹ï¼šçº¿æ€§ç›¸ä½ (Linear Phase)</h1>
    <p class="subtitle">åŸç† Â· ç±»æ¯” Â· æ³¢å½¢ Â· å¬è§‰ Â· è§†è§‰ â€”â€” å…¨æ–¹ä½è§£æ</p>
</header>

<div class="container">

    <!-- 1. ç†è®ºåŸºç¡€ -->
    <div class="card">
        <h2>1. ç†è®ºåŸºç¡€ï¼šæ•°å­¦å®šä¹‰ä¸ç‰©ç†æ„ä¹‰</h2>
        <div class="math-block">
            <p><strong>å®šä¹‰ï¼š</strong> å¦‚æœä¸€ä¸ªç³»ç»Ÿçš„ç›¸ä½å“åº” $\theta(\omega)$ æ˜¯é¢‘ç‡ $\omega$ çš„çº¿æ€§å‡½æ•°ï¼š</p>
            $$ \theta(\omega) = -k \cdot \omega $$
            <p>åˆ™è¯¥ç³»ç»Ÿå…·æœ‰<strong>çº¿æ€§ç›¸ä½</strong>ã€‚</p>
            <p><strong>ç¾¤å»¶æ—¶ (Group Delay)ï¼š</strong> å¯¹ç›¸ä½æ±‚å¯¼çš„è´Ÿæ•°å³ä¸ºç¾¤å»¶æ—¶ï¼š</p>
            $$ \tau_g(\omega) = -\frac{d\theta(\omega)}{d\omega} = k = \text{å¸¸æ•°} $$
        </div>
        <p><strong>é€šä¿—è§£é‡Šï¼š</strong> çº¿æ€§ç›¸ä½æ„å‘³ç€ä¿¡å·ä¸­æ‰€æœ‰çš„é¢‘ç‡æˆåˆ†ï¼ˆæ— è®ºæ˜¯ä½é¢‘è¿˜æ˜¯é«˜é¢‘ï¼‰ï¼Œéƒ½ç»å†äº†<strong>å®Œå…¨ç›¸åŒçš„æ—¶é—´å»¶è¿Ÿ</strong>ã€‚è¿™ä¿è¯äº†ä¿¡å·çš„æ³¢å½¢â€œå½¢çŠ¶â€ä¸ä¼šå‘ç”Ÿæ”¹å˜ã€‚</p>
    </div>

    <!-- 2. ä»ªä»—é˜ŸåŠ¨ç”» (Original) -->
    <div class="card">
        <h2>2. å½¢è±¡ç±»æ¯”ï¼šä»ªä»—é˜Ÿçš„è¡Œè¿›</h2>
        <p>æƒ³è±¡ä¸åŒé¢‘ç‡çš„ä¿¡å·æ˜¯èº«é«˜ä¸åŒçš„äººã€‚æˆ‘ä»¬è¦è®©ä»–ä»¬ä¿æŒé˜Ÿå½¢ä»èµ·ç‚¹èµ°åˆ°ç»ˆç‚¹ã€‚</p>
        <div class="lab-container">
            <div class="lab-visual">
                <canvas id="marchCanvas" height="180"></canvas>
            </div>
            <div class="lab-controls">
                <div id="marchStatus" class="status-badge badge-linear">å½“å‰ï¼šçº¿æ€§ç›¸ä½</div>
                <p style="font-size:0.9rem; color:#666;">
                    <strong>çº¿æ€§ï¼š</strong> æ‰€æœ‰äººé€Ÿåº¦åè°ƒä¸€è‡´ï¼Œèµ°äº†ç›¸åŒçš„æ—¶é—´ï¼Œå‰è¿›äº†ç›¸åŒçš„è·ç¦»ã€‚é˜Ÿå½¢ï¼ˆæ³¢å½¢ï¼‰ä¿æŒæ•´é½ã€‚
                </p>
                <button class="btn-toggle" onclick="toggleMarch()">åˆ‡æ¢æ¨¡å¼ (Linear vs Non-Linear)</button>
            </div>
        </div>
    </div>

    <!-- 3. æ³¢å½¢åˆæˆå®éªŒå®¤ (Original) -->
    <div class="card">
        <h2>3. ä¿¡å·å®éªŒå®¤ï¼šæ³¢å½¢æ˜¯å¦‚ä½•â€œç•¸å˜â€çš„ï¼Ÿ</h2>
        <p>æ‹–åŠ¨æ»‘å—ï¼Œè§‚å¯Ÿç›¸ä½å¯¹æ³¢å½¢å½¢çŠ¶çš„å½±å“ã€‚åŸºæ³¢ï¼ˆè“è‰²ï¼‰å’Œè°æ³¢ï¼ˆç´«è‰²ï¼‰å åŠ å½¢æˆåˆæˆæ³¢ï¼ˆç»¿è‰²/çº¢è‰²ï¼‰ã€‚</p>
        <div class="lab-container">
            <div class="lab-visual">
                <canvas id="waveCanvas" height="300"></canvas>
            </div>
            <div class="lab-controls">
                <div id="waveStatus" class="status-badge badge-linear">æ¨¡å¼ï¼šçº¿æ€§ç›¸ä½ (é”å®š)</div>
                
                <label>ç³»ç»Ÿæ€»å»¶æ—¶: <span id="valDelay">0.0 ms</span></label>
                <input type="range" id="sliderDelay" min="0" max="50" value="0" step="0.5">
                
                <div style="border-top:1px dashed #ccc; margin:15px 0;"></div>
                
                <label>é¢å¤–ç›¸ä½ç•¸å˜: <span id="valDistort">0.0 rad</span></label>
                <input type="range" id="sliderDistort" min="-3" max="3" value="0" step="0.1" disabled>
                <p style="font-size:0.8rem; color:#888;" id="distortMsg">* çº¿æ€§æ¨¡å¼ä¸‹ï¼Œç¾¤å»¶æ—¶æ’å®šï¼Œæ— æ³•äº§ç”Ÿç•¸å˜ã€‚</p>

                <button class="btn-toggle" onclick="toggleWaveMode()">è§£é”/é”å®š éçº¿æ€§æ¨¡å¼</button>
            </div>
        </div>
    </div>

    <!-- 4. å¬è§‰å®éªŒ (Latest Audio) -->
    <div class="card">
        <h2>4. å¬è§‰å®éªŒï¼šæ—‹å¾‹ä¸­çš„â€œè‰²æ•£â€</h2>
        <p>ä½¿ç”¨åŒ…å«ä¸°å¯Œè°æ³¢çš„<strong>é”¯é½¿æ³¢</strong>æ¼”å¥ã€Šæ¬¢ä¹é¢‚ã€‹ã€‚å¯¹æ¯”ç»è¿‡<strong>60çº§å…¨é€šæ»¤æ³¢å™¨</strong>å‰åçš„å£°éŸ³ã€‚</p>
        <div class="lab-container">
            <div class="lab-visual">
                <canvas id="audioCanvas" height="150"></canvas>
                <div id="audioText" style="text-align:center; margin-top:5px; color:#666;">ç­‰å¾…æ’­æ”¾...</div>
            </div>
            <div class="lab-controls">
                <button class="btn-linear" onclick="playMelody(true)">ğŸµ æ’­æ”¾ï¼šçº¿æ€§ç›¸ä½ (æ ‡å‡†)</button>
                <p style="font-size:0.8rem; margin:0 0 10px 0;">å¬æ„Ÿï¼šå£°éŸ³ç´§å®ã€å¹²è„†ã€‚</p>
                
                <button class="btn-nonlinear" onclick="playMelody(false)">ğŸŒ€ æ’­æ”¾ï¼šéçº¿æ€§ç›¸ä½ (è‰²æ•£)</button>
                <p style="font-size:0.8rem; margin:0 0 10px 0;">å¬æ„Ÿï¼šæ¯ä¸ªéŸ³ç¬¦éƒ½æœ‰"Peww"çš„æ¿€å…‰å£°/å¼¹ç°§å£°ï¼ˆé«˜é¢‘ä½é¢‘åˆ°è¾¾æ—¶é—´é”™ä¹±ï¼‰ã€‚</p>
                
                <button class="btn-reset" onclick="stopAudio()">â¹ åœæ­¢æ’­æ”¾</button>
            </div>
        </div>
    </div>

    <!-- 5. è§†è§‰å®éªŒ (Latest Image) -->
    <div class="card">
        <h2>5. è§†è§‰å®éªŒï¼šå½©è‰²å›¾åƒæ‹–å°¾</h2>
        <p>å¯¹æ¯”ä¸¤ç§ä½é€šæ»¤æ³¢å™¨å¯¹å½©è‰²æµ‹è¯•å¡è¾¹ç¼˜çš„å½±å“ã€‚è¿™ç›´æ¥è§£é‡Šäº†ä¸ºä»€ä¹ˆå›¾åƒå¤„ç†åçˆ± FIR æ»¤æ³¢å™¨ã€‚</p>
        <div class="lab-container">
            <div class="lab-visual">
                <canvas id="imageCanvas" width="500" height="300"></canvas>
                <div id="imageText" style="text-align:center; margin-top:5px; font-weight:bold;">åŸå§‹å›¾åƒ</div>
            </div>
            <div class="lab-controls">
                <button class="btn-reset" onclick="resetImage()">ğŸ”„ é‡ç½®åŸå§‹å›¾åƒ</button>
                
                <button class="btn-linear" onclick="applyLinearFilter()">âœ… çº¿æ€§ç›¸ä½ (FIR)</button>
                <p style="font-size:0.8rem; margin:0 0 10px 0;">æ•ˆæœï¼šç£¨ç ‚ç»ç’ƒæ„Ÿã€‚æ¨¡ç³Šæ˜¯å¯¹ç§°çš„ï¼Œç‰©ä½“ä½ç½®ä¸å˜ã€‚</p>
                
                <button class="btn-nonlinear" onclick="applyNonLinearFilter()">âŒ éçº¿æ€§ç›¸ä½ (IIR)</button>
                <p style="font-size:0.8rem; margin:0 0 10px 0;">æ•ˆæœï¼šè¿åŠ¨æ¨¡ç³Šæ„Ÿã€‚é¢œè‰²å‘å³æº¢å‡ºï¼Œäº§ç”Ÿä¸¥é‡æ‹–å°¾ã€‚</p>
            </div>
        </div>
    </div>

</div>

<script>
    // ==========================================
    // æ¨¡å— 1: ä»ªä»—é˜ŸåŠ¨ç”» (Marching Soldiers)
    // ==========================================
    const marchCanvas = document.getElementById('marchCanvas');
    const mCtx = marchCanvas.getContext('2d');
    let isLinearMarch = true;
    let marchFrame = 0;
    
    // è‡ªé€‚åº”å¤§å°
    marchCanvas.width = marchCanvas.clientWidth;
    marchCanvas.height = marchCanvas.clientHeight;

    const soldiers = [
        { color: '#3498db', speedFactor: 1.0 }, // æ…¢
        { color: '#9b59b6', speedFactor: 1.2 },
        { color: '#e74c3c', speedFactor: 1.5 }, // å¿«
    ];

    function drawMarch() {
        const w = marchCanvas.width;
        const h = marchCanvas.height;
        mCtx.clearRect(0,0,w,h);

        // ç»ˆç‚¹çº¿
        const finishX = w - 60;
        mCtx.beginPath(); mCtx.setLineDash([5,5]); mCtx.moveTo(finishX, 0); mCtx.lineTo(finishX, h); 
        mCtx.strokeStyle='#aaa'; mCtx.stroke(); mCtx.setLineDash([]);

        soldiers.forEach((s, i) => {
            const y = 40 + i * 50;
            let x = 0;
            if (isLinearMarch) {
                // çº¿æ€§ï¼šé€Ÿåº¦ä¸€è‡´
                x = (marchFrame % w);
            } else {
                // éçº¿æ€§ï¼šé€Ÿåº¦ä¸åŒ
                x = (marchFrame * s.speedFactor) % w;
            }
            // ç»˜åˆ¶æ–¹å—
            mCtx.fillStyle = s.color;
            mCtx.fillRect(x, y, 30, 30);
            // ç»˜åˆ¶æ–‡å­—
            mCtx.fillStyle = '#333'; mCtx.font='12px Arial';
            mCtx.fillText(isLinearMarch ? "åŒæ­¥" : "é”™ä¹±", x, y-5);
        });

        marchFrame += 1.5;
        requestAnimationFrame(drawMarch);
    }

    function toggleMarch() {
        isLinearMarch = !isLinearMarch;
        const badge = document.getElementById('marchStatus');
        if(isLinearMarch) {
            badge.className = "status-badge badge-linear";
            badge.innerText = "å½“å‰ï¼šçº¿æ€§ç›¸ä½";
        } else {
            badge.className = "status-badge badge-nonlinear";
            badge.innerText = "å½“å‰ï¼šéçº¿æ€§ç›¸ä½";
        }
        marchFrame = 0;
    }
    drawMarch(); // å¯åŠ¨


    // ==========================================
    // æ¨¡å— 2: æ³¢å½¢åˆæˆå®éªŒå®¤ (Wave Lab)
    // ==========================================
    const waveCanvas = document.getElementById('waveCanvas');
    const wCtx = waveCanvas.getContext('2d');
    const sliderDelay = document.getElementById('sliderDelay');
    const sliderDistort = document.getElementById('sliderDistort');
    
    let isLinearWave = true;
    let timeDelay = 0;
    let distortPhase = 0;

    waveCanvas.width = waveCanvas.clientWidth;
    waveCanvas.height = waveCanvas.clientHeight;

    function drawWaves() {
        const w = waveCanvas.width;
        const h = waveCanvas.height;
        const rowH = h / 3;
        wCtx.clearRect(0,0,w,h);
        
        const freq = 0.05;

        // 1. åŸºæ³¢ (Blue)
        drawSingleWave(0, "åŸºæ³¢ (Fundamental)", t => Math.sin(freq * (t - timeDelay)), '#3498db');
        
        // 2. è°æ³¢ (Purple)
        drawSingleWave(rowH, "ä¸‰æ¬¡è°æ³¢ (Harmonic)", t => 0.5 * Math.sin(3 * freq * (t - timeDelay) + distortPhase), '#9b59b6');

        // 3. åˆæˆ (Green/Red)
        const isDistorted = Math.abs(distortPhase) > 0.1;
        const color = isDistorted ? '#c0392b' : '#27ae60';
        const label = isDistorted ? "åˆæˆï¼šå½¢çŠ¶ç•¸å˜" : "åˆæˆï¼šå½¢çŠ¶ä¿æŒ";
        
        drawSingleWave(rowH*2, label, t => {
            return Math.sin(freq * (t - timeDelay)) + 0.5 * Math.sin(3 * freq * (t - timeDelay) + distortPhase);
        }, color, true); // show ghost
    }

    function drawSingleWave(offsetY, label, func, color, ghost=false) {
        const w = waveCanvas.width;
        const midY = offsetY + (waveCanvas.height/3)/2;
        
        if(ghost) {
            wCtx.beginPath(); wCtx.strokeStyle='#eee'; wCtx.lineWidth=2;
            const freq = 0.05;
            for(let x=0; x<w; x++) {
                let y = Math.sin(freq*x) + 0.5*Math.sin(3*freq*x);
                wCtx.lineTo(x, midY - y*30);
            }
            wCtx.stroke();
        }

        wCtx.beginPath(); wCtx.strokeStyle=color; wCtx.lineWidth=3;
        for(let x=0; x<w; x++) {
            wCtx.lineTo(x, midY - func(x)*30);
        }
        wCtx.stroke();
        
        wCtx.fillStyle=color; wCtx.font="bold 12px Arial";
        wCtx.fillText(label, 10, offsetY+20);
        wCtx.beginPath(); wCtx.strokeStyle='#eee'; wCtx.lineWidth=1;
        wCtx.moveTo(0, offsetY + waveCanvas.height/3); wCtx.lineTo(w, offsetY + waveCanvas.height/3); wCtx.stroke();
    }

    function updateWave() {
        timeDelay = parseFloat(sliderDelay.value) * 5;
        distortPhase = isLinearWave ? 0 : parseFloat(sliderDistort.value);
        
        document.getElementById('valDelay').innerText = sliderDelay.value + " ms";
        document.getElementById('valDistort').innerText = distortPhase.toFixed(1) + " rad";
        drawWaves();
    }

    function toggleWaveMode() {
        isLinearWave = !isLinearWave;
        const badge = document.getElementById('waveStatus');
        const msg = document.getElementById('distortMsg');
        
        if(isLinearWave) {
            badge.className = "status-badge badge-linear";
            badge.innerText = "æ¨¡å¼ï¼šçº¿æ€§ç›¸ä½ (é”å®š)";
            sliderDistort.disabled = true;
            sliderDistort.value = 0;
            msg.style.display = 'block';
        } else {
            badge.className = "status-badge badge-nonlinear";
            badge.innerText = "æ¨¡å¼ï¼šéçº¿æ€§ (è‡ªç”±)";
            sliderDistort.disabled = false;
            msg.style.display = 'none';
        }
        updateWave();
    }

    sliderDelay.oninput = updateWave;
    sliderDistort.oninput = updateWave;
    drawWaves(); // å¯åŠ¨


    // ==========================================
    // æ¨¡å— 3: éŸ³é¢‘å®éªŒ (æ¬¢ä¹é¢‚ + 60çº§å…¨é€š)
    // ==========================================
    let audioCtx = null;
    let oscList = [];
    let isAudioPlaying = false;

    const melody = [
        {note: 'E4', dur: 0.3}, {note: 'E4', dur: 0.3}, {note: 'F4', dur: 0.3}, {note: 'G4', dur: 0.3},
        {note: 'G4', dur: 0.3}, {note: 'F4', dur: 0.3}, {note: 'E4', dur: 0.3}, {note: 'D4', dur: 0.3},
        {note: 'C4', dur: 0.3}, {note: 'C4', dur: 0.3}, {note: 'D4', dur: 0.3}, {note: 'E4', dur: 0.3},
        {note: 'E4', dur: 0.5}, {note: 'D4', dur: 0.15}, {note: 'D4', dur: 0.6}
    ];
    const freqs = { 'C4': 261.6, 'D4': 293.7, 'E4': 329.6, 'F4': 349.2, 'G4': 392.0 };

    function initAudio() {
        if(!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        if(audioCtx.state === 'suspended') audioCtx.resume();
    }

    function createDispersion(ctx, input, output) {
        let node = input;
        for(let i=0; i<60; i++) {
            let f = ctx.createBiquadFilter();
            f.type = 'allpass';
            f.frequency.value = 100 * Math.pow(1.05, i);
            f.Q.value = 10;
            node.connect(f);
            node = f;
        }
        node.connect(output);
    }

    function playMelody(isLinear) {
        stopAudio();
        initAudio();
        isAudioPlaying = true;
        
        document.getElementById('audioText').innerText = isLinear ? "æ’­æ”¾ä¸­ï¼šçº¿æ€§ (æ¸…æ™°)" : "æ’­æ”¾ä¸­ï¼šéçº¿æ€§ (è‰²æ•£)";
        document.getElementById('audioText').style.color = isLinear ? "#27ae60" : "#c0392b";
        visAudio(true, isLinear);

        let t = audioCtx.currentTime + 0.1;
        melody.forEach(m => {
            let osc = audioCtx.createOscillator();
            let gain = audioCtx.createGain();
            osc.type = 'sawtooth';
            osc.frequency.value = freqs[m.note];
            
            // Envelope
            gain.gain.setValueAtTime(0, t);
            gain.gain.linearRampToValueAtTime(0.15, t+0.02);
            gain.gain.exponentialRampToValueAtTime(0.001, t+m.dur*0.9);

            if(isLinear) {
                osc.connect(gain);
                gain.connect(audioCtx.destination);
            } else {
                osc.connect(gain);
                createDispersion(audioCtx, gain, audioCtx.destination);
            }
            
            osc.start(t);
            osc.stop(t+m.dur);
            oscList.push(osc);
            t += m.dur;
        });

        setTimeout(() => {
            if(isAudioPlaying) {
                document.getElementById('audioText').innerText = "æ’­æ”¾ç»“æŸ";
                visAudio(false);
                isAudioPlaying = false;
            }
        }, t*1000 - audioCtx.currentTime*1000 + 500);
    }

    function stopAudio() {
        oscList.forEach(o => { try{o.stop()}catch(e){} });
        oscList = [];
        isAudioPlaying = false;
        document.getElementById('audioText').innerText = "å·²åœæ­¢";
        visAudio(false);
    }

    // éŸ³é¢‘å¯è§†åŒ–
    const cvsAud = document.getElementById('audioCanvas');
    const ctxAud = cvsAud.getContext('2d');
    let audAnim;
    
    cvsAud.width = cvsAud.clientWidth;
    cvsAud.height = cvsAud.clientHeight;

    function visAudio(active, isLinear=true) {
        if(audAnim) cancelAnimationFrame(audAnim);
        
        function loop() {
            const w = cvsAud.width;
            const h = cvsAud.height;
            ctxAud.clearRect(0,0,w,h);
            ctxAud.fillStyle = '#f9f9f9'; ctxAud.fillRect(0,0,w,h);

            if(!active) return;

            ctxAud.beginPath();
            ctxAud.strokeStyle = isLinear ? '#27ae60' : '#c0392b';
            ctxAud.lineWidth = 2;
            const time = Date.now()/60;
            
            for(let x=0; x<w; x++) {
                let y = Math.sin(x*0.1 - time) * 20 * Math.sin(x*0.02);
                if(!isLinear) y += Math.sin(x*0.3 - time*2)*10; // Add noise
                ctxAud.lineTo(x, h/2 + y);
            }
            ctxAud.stroke();
            if(active) audAnim = requestAnimationFrame(loop);
        }
        loop();
    }


    // ==========================================
    // æ¨¡å— 4: å›¾åƒå®éªŒ (å½©è‰² + é€’å½’)
    // ==========================================
    const cvsImg = document.getElementById('imageCanvas');
    const ctxImg = cvsImg.getContext('2d');
    const wImg = cvsImg.width;
    const hImg = cvsImg.height;

    function drawTestPattern() {
        ctxImg.fillStyle = '#fff'; ctxImg.fillRect(0,0,wImg,hImg);
        
        // RGB Blocks
        ctxImg.fillStyle = '#e74c3c'; ctxImg.fillRect(50,50,80,80);
        ctxImg.fillStyle = '#2ecc71'; ctxImg.fillRect(150,50,80,80);
        ctxImg.fillStyle = '#3498db'; ctxImg.fillRect(250,50,80,80);
        
        // Text
        ctxImg.font = "bold 50px Arial"; ctxImg.fillStyle='#000';
        ctxImg.fillText("LINEAR", 350, 90);
        ctxImg.fillText("PHASE", 350, 150);

        // Lines
        ctxImg.lineWidth=8; ctxImg.strokeStyle='#333';
        ctxImg.beginPath(); ctxImg.moveTo(50,200); ctxImg.lineTo(450,200); ctxImg.stroke();
        
        // Circle
        ctxImg.beginPath(); ctxImg.arc(100, 250, 40, 0, Math.PI*2); 
        ctxImg.fillStyle='#f1c40f'; ctxImg.fill();

        document.getElementById('imageText').innerText = "å½“å‰ï¼šåŸå§‹å›¾åƒ";
        document.getElementById('imageText').style.color = "#333";
    }

    function resetImage() { drawTestPattern(); }

    function applyLinearFilter() {
        drawTestPattern();
        const src = ctxImg.getImageData(0,0,wImg,hImg).data;
        const dst = ctxImg.createImageData(wImg,hImg);
        const d = dst.data;

        // Symmetric Blur [0.1, 0.2, 0.4, 0.2, 0.1]
        for(let y=0; y<hImg; y++) {
            for(let x=2; x<wImg-2; x++) {
                let idx = (y*wImg+x)*4;
                for(let c=0; c<3; c++) {
                    d[idx+c] = src[((y*wImg+x-2)*4)+c]*0.1 + 
                               src[((y*wImg+x-1)*4)+c]*0.2 + 
                               src[idx+c]*0.4 + 
                               src[((y*wImg+x+1)*4)+c]*0.2 + 
                               src[((y*wImg+x+2)*4)+c]*0.1;
                }
                d[idx+3]=255;
            }
        }
        ctxImg.putImageData(dst,0,0);
        document.getElementById('imageText').innerText = "çº¿æ€§ç›¸ä½ï¼šå¯¹ç§°æ¨¡ç³Šï¼Œæ— ä½ç§»";
        document.getElementById('imageText').style.color = "#27ae60";
    }

    function applyNonLinearFilter() {
        drawTestPattern();
        const src = ctxImg.getImageData(0,0,wImg,hImg).data;
        const dst = ctxImg.createImageData(wImg,hImg);
        const d = dst.data;

        // IIR Recursive: y[n] = (1-a)x[n] + a*y[n-1]
        const a = 0.85; 
        const b = 1-a;

        for(let y=0; y<hImg; y++) {
            let pr=255, pg=255, pb=255;
            for(let x=0; x<wImg; x++) {
                let idx = (y*wImg+x)*4;
                
                let r = src[idx]*b + pr*a; pr=r; d[idx]=r;
                let g = src[idx+1]*b + pg*a; pg=g; d[idx+1]=g;
                let bl = src[idx+2]*b + pb*a; pb=bl; d[idx+2]=bl;
                
                d[idx+3]=255;
            }
        }
        ctxImg.putImageData(dst,0,0);
        document.getElementById('imageText').innerText = "éçº¿æ€§ç›¸ä½ï¼šå‘å³æ‹–å°¾ï¼Œä¸å¯¹ç§°";
        document.getElementById('imageText').style.color = "#c0392b";
    }

    // Init
    window.onload = function() {
        drawTestPattern();
    }

</script>

</body>
</html>