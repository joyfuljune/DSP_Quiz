<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>ç³»ç»Ÿå“åº”åŸç†æ¼”ç¤º</title>
    <style>
        body {
            font-family: 'PingFang SC', 'Microsoft YaHei', sans-serif;
            background-color: #ffffff; /* çº¯ç™½èƒŒæ™¯ï¼Œæ›´åƒæ•™ç§‘ä¹¦ */
            color: #333; /* æ·±ç°å­—ä½“ */
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
            margin: 0;
            user-select: none;
        }

        h1 { margin-bottom: 10px; letter-spacing: 1px; color: #000; font-size: 28px; }
        .subtitle { color: #555; font-size: 18px; margin-bottom: 35px; font-weight: normal; }

        /* å¸ƒå±€å®¹å™¨ */
        .stage-container {
            display: flex;
            flex-direction: row;
            gap: 25px;
            justify-content: center;
            align-items: stretch;
            width: 100%;
            max-width: 1400px; /* åŠ å®½ï¼Œé€‚åº”å¤§å­—å· */
        }

        /* é¢æ¿å¡ç‰‡ */
        .panel {
            background: #fdfdfd;
            border-radius: 8px;
            padding: 25px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.08);
            border: 1px solid #ddd;
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .panel-title {
            width: 100%;
            border-bottom: 2px solid #eee;
            padding-bottom: 15px;
            margin-bottom: 20px;
            text-align: center;
            font-weight: bold;
            color: #222;
            font-size: 20px; /* æ ‡é¢˜å­—å·åŠ å¤§ */
        }

        canvas {
            width: 100%;
            height: 280px; /* å›¾åƒé«˜åº¦å¢åŠ  */
            background: #fafafa;
            border-radius: 4px;
            border: 1px solid #ccc;
        }

        .desc-box {
            margin-top: 20px;
            background: #f0f0f0;
            border-radius: 6px;
            padding: 15px;
            font-size: 16px; /* è¯´æ˜æ–‡å­—å·åŠ å¤§ */
            color: #333;     /* æ·±ç°è‰² */
            width: 95%;
            line-height: 1.8;
            text-align: left;
        }

        .badge {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
            vertical-align: middle;
        }

        /* æŒ‰é’®è®¾è®¡ */
        #btnStrike {
            margin-top: 50px;
            padding: 16px 70px;
            font-size: 20px;
            border: none;
            border-radius: 6px;
            background: #2c3e50;
            color: white;
            font-weight: bold;
            cursor: pointer;
            box-shadow: 0 6px 15px rgba(0,0,0,0.2);
            transition: background 0.2s;
        }

        #btnStrike:hover { background: #34495e; }
        #btnStrike:disabled { background: #95a5a6; cursor: default; }

    </style>
</head>
<body>

    <h1>ç³»ç»Ÿå“åº”åŸç†ï¼šä»æ•²å‡»åˆ°é¢‘ç‡ç‰¹æ€§</h1>
    <div class="subtitle">
        åŸç†è§£æï¼šé€šè¿‡å•ä½è„‰å†²å“åº” h[n] è§‚å¯Ÿç³»ç»Ÿå¦‚ä½•æ„å»º H(e<sup>jÏ‰</sup>)
    </div>

    <div class="stage-container">
        
        <!-- é¢æ¿1 -->
        <div class="panel">
            <div class="panel-title">1. ç‰©ç†æ¿€åŠ±</div>
            <canvas id="bellCanvas" width="400" height="300"></canvas>
            <div class="desc-box">
                <b>åŠ¨ä½œï¼š</b>é‡é”¤æ•²å‡»<br>
                <b>æ•°å­¦å«ä¹‰ï¼š</b>å•ä½è„‰å†² Î´[n]ã€‚<br>
                æ•²å‡»ç¬é—´ä¸ºç³»ç»Ÿæ³¨å…¥èƒ½é‡ï¼Œæ¿€å‘ç³»ç»Ÿäº§ç”Ÿå…¶å›ºæœ‰çš„éœ‡åŠ¨æ¨¡å¼ã€‚
            </div>
        </div>

        <!-- é¢æ¿2 -->
        <div class="panel">
            <div class="panel-title">2. æ—¶åŸŸå“åº” h[n]</div>
            <canvas id="timeCanvas" width="400" height="300"></canvas>
            <div class="desc-box">
                <span class="badge" style="background:#2980b9"></span><b>è“è‰²æ³¢å½¢</b><br>
                <b>ç°è±¡ï¼š</b>æ³¢å½¢éœ‡è¡å¹¶éšæ—¶é—´è¡°å‡ã€‚<br>
                <b>æ­£ç¡®ç†è§£ï¼š</b>æ³¢å½¢çš„â€œå¿½å¤§å¿½å°â€ï¼ˆåŒ…ç»œå˜åŒ–ï¼‰æ˜¯ç”±äºå¤šä¸ªå›ºæœ‰é¢‘ç‡ç›¸äº’å¹²æ¶‰å åŠ çš„ç»“æœï¼Œè¿™æ˜¯å¤æ‚ç³»ç»Ÿ h[n] çš„çœŸå®å½¢æ€ã€‚
            </div>
        </div>

        <!-- é¢æ¿3 -->
        <div class="panel">
            <div class="panel-title">3. é¢‘ç‡å“åº” H(e<sup>jÏ‰</sup>)</div>
            <canvas id="freqCanvas" width="400" height="300"></canvas>
            <div class="desc-box">
                <span class="badge" style="background:#c0392b"></span><b>çº¢ç‚¹</b>ï¼šå½“å‰é¢‘ç‡æˆåˆ†<br>
                <span class="badge" style="background:rgba(142, 68, 173, 0.3)"></span><b>ç´«è‰²åŒºåŸŸ</b>ï¼šç´¯ç§¯å“åº”æ›²çº¿<br>
                éšç€æ—¶åŸŸéœ‡è¡çš„è¿›è¡Œï¼Œæˆ‘ä»¬èƒ½â€œæ‰«æâ€å‡ºç³»ç»Ÿå¯¹ä¸åŒé¢‘ç‡ï¼ˆä»é«˜é¢‘åˆ°ä½é¢‘ï¼‰çš„æ”¾å¤§ç‰¹æ€§ã€‚
            </div>
        </div>

    </div>

    <button id="btnStrike">ğŸ”Š æ•²å‡»å¤§é’Ÿ (æ¼”ç¤ºå¼€å§‹)</button>

    <script>
        // --- ç»˜å›¾ä¸Šä¸‹æ–‡ ---
        const bellCtx = document.getElementById('bellCanvas').getContext('2d');
        const tCtx = document.getElementById('timeCanvas').getContext('2d');
        const fCtx = document.getElementById('freqCanvas').getContext('2d');
        const btn = document.getElementById('btnStrike');

        // --- å…¨å±€é…ç½® ---
        // åŠ¨ç”»æ—¶é•¿çº¦ 6.5 ç§’
        const totalDuration = 400; 
        let isRunning = false;
        let frameCount = 0;

        // --- ä¿¡å·å‚æ•° ---
        let startFreq = 0.95; // åˆå§‹é«˜é¢‘
        let endFreq = 0.1;    // ç»“æŸä½é¢‘
        
        // ä¸¤ä¸ªç›¸ä½ç”¨äºåˆ¶é€ æ³¢å½¢çš„å¹²æ¶‰ï¼ˆæ‹é¢‘ï¼‰æ•ˆæœ
        let phase1 = 0;
        let phase2 = 0;
        
        // --- ç¼“å†²åŒº ---
        let waveBuffer = new Array(400).fill(0);
        let spectrumHistory = new Array(400).fill(0);

        // --- ç‰©ç†åŠ¨ç”»çŠ¶æ€ ---
        let bellShake = 0;
        let hammerState = 0; 

        // --- éŸ³é¢‘å¼•æ“ ---
        let audioCtx = null;

        function playDeepBellSound() {
            if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            const now = audioCtx.currentTime;
            
            // åŸºç¡€é¢‘ç‡ï¼š160Hz (è¾ƒæ·±æ²‰)
            const fund = 160; 

            // è°æ³¢ç»“æ„ï¼š[å€ç‡, éŸ³é‡, æŒç»­æ—¶é•¿]
            // è¿™é‡Œä½¿ç”¨äº†å¤æ‚çš„éæ•´æ•°å€æ³›éŸ³ï¼Œæ¨¡æ‹ŸçœŸå®é‡‘å±é’Ÿå£°
            const harmonics = [
                [0.5,  0.5, 7.0],  // æ¬¡ä½éŸ³
                [1.0,  1.0, 6.5],  // åŸºéŸ³
                [1.2,  0.7, 5.0],  // å°ä¸‰åº¦ (åˆ¶é€ æ‚²å‡‰æ„Ÿ)
                [1.5,  0.5, 4.0],  // äº”åº¦
                [2.0,  0.4, 3.0],  // å…«åº¦
                [2.7,  0.2, 1.5],  // é«˜é¢‘é‡‘å±éŸ³
                [4.2,  0.1, 0.4]   // ç¬é—´æ’å‡»å£°
            ];

            harmonics.forEach(h => {
                createLayeredOscillator(fund * h[0], h[1], h[2], now);
            });
        }

        function createLayeredOscillator(freq, peakGain, duration, startTime) {
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            
            // å¾®å°çš„é¢‘ç‡åç§»åˆ¶é€ è‡ªç„¶çš„æ³¢åŠ¨æ„Ÿ
            const detune = (Math.random() - 0.5) * 4; 
            osc.frequency.value = freq + detune;
            osc.type = 'sine'; 

            // åŒ…ç»œï¼šç¬é—´èµ·éŸ³ï¼Œé•¿æŒ‡æ•°è¡°å‡
            gain.gain.setValueAtTime(0, startTime);
            gain.gain.linearRampToValueAtTime(peakGain, startTime + 0.02); 
            gain.gain.exponentialRampToValueAtTime(0.001, startTime + duration);

            osc.connect(gain);
            gain.connect(audioCtx.destination);
            
            osc.start(startTime);
            osc.stop(startTime + duration);
        }


        // --- ç»˜å›¾é€»è¾‘ ---

        function drawBellScene(ctx, shake, hammerAngle) {
            ctx.clearRect(0, 0, 400, 300);
            ctx.save();
            ctx.translate(200, 70); 

            // æ¨ªæ¢
            ctx.fillStyle = "#444";
            ctx.fillRect(-140, -15, 280, 20);

            // éœ‡åŠ¨
            ctx.save();
            ctx.translate(0, 25); 
            ctx.rotate((Math.random()-0.5) * shake * 0.05);

            // --- é’Ÿä½“ ---
            ctx.beginPath();
            ctx.moveTo(0,0);
            ctx.bezierCurveTo(70, 10, 110, 130, 130, 170); 
            ctx.lineTo(-130, 170); 
            ctx.bezierCurveTo(-110, 130, -70, 10, 0, 0); 
            
            // æè´¨ï¼šå¤é“œè‰²
            let grad = ctx.createLinearGradient(-100, 0, 100, 170);
            grad.addColorStop(0, "#D6C098"); 
            grad.addColorStop(0.4, "#8C7350"); 
            grad.addColorStop(1, "#3E2715"); 
            ctx.fillStyle = grad;
            ctx.fill();

            // çº¹ç†
            ctx.strokeStyle = "rgba(0,0,0,0.15)";
            ctx.lineWidth = 3;
            ctx.beginPath(); ctx.moveTo(-70, 60); ctx.lineTo(70, 60); ctx.stroke();
            ctx.beginPath(); ctx.moveTo(-100, 120); ctx.lineTo(100, 120); ctx.stroke();
            
            // é’Ÿæ‘†
            ctx.beginPath(); ctx.arc(0, 170, 20, 0, Math.PI*2);
            ctx.fillStyle = "#111"; ctx.fill();

            ctx.restore(); 
            ctx.restore(); 

            // é”¤å­
            ctx.save();
            ctx.translate(340, 170); 
            ctx.rotate(hammerAngle);
            ctx.fillStyle = "#5D4037"; ctx.fillRect(-12, -110, 24, 110);
            ctx.fillStyle = "#222"; 
            ctx.beginPath(); ctx.roundRect(-35, -120, 70, 45, 10); ctx.fill();
            ctx.restore();
        }

        function drawTimeDomain(ctx) {
            ctx.clearRect(0,0,400,300);
            
            // åæ ‡è½´
            ctx.strokeStyle = "#999"; 
            ctx.lineWidth = 1;
            ctx.beginPath(); ctx.moveTo(40,150); ctx.lineTo(380,150); ctx.stroke(); // X
            ctx.beginPath(); ctx.moveTo(40,150); ctx.lineTo(40,30); ctx.stroke();   // Y (å¹…åº¦)
            
            // æ–‡å­—
            ctx.fillStyle = "#333";
            ctx.font = "bold 16px Arial";
            ctx.fillText("n (æ—¶é—´)", 340, 175);
            ctx.fillText("å¹…åº¦", 10, 40);

            // æ³¢å½¢
            ctx.beginPath();
            ctx.strokeStyle = "#2980b9";
            ctx.lineWidth = 2;
            for(let i=0; i<waveBuffer.length; i++) {
                // ç»˜åˆ¶ bufferï¼Œæ°´å¹³æ‹‰ä¼¸ä»¥å¡«æ»¡ç”»å¸ƒ
                let x = 40 + (i / waveBuffer.length) * 340;
                let y = 150 - waveBuffer[i] * 1.5;
                if(i===0) ctx.moveTo(x, y);
                else ctx.lineTo(x, y);
            }
            ctx.stroke();
        }

        function drawFreqDomain(ctx) {
            ctx.clearRect(0,0,400,300);

            // åæ ‡è½´
            ctx.strokeStyle = "#333";
            ctx.lineWidth = 2;
            ctx.beginPath(); 
            ctx.moveTo(50, 260); ctx.lineTo(380, 260); // Xè½´
            ctx.moveTo(50, 260); ctx.lineTo(50, 20);   // Yè½´
            ctx.stroke();
            
            // åˆ»åº¦æ–‡å­—
            ctx.fillStyle = "#333";
            ctx.font = "bold 16px Arial";
            ctx.textAlign = "center";
            ctx.fillText("0", 50, 285);
            ctx.fillText("Ï€ (é¢‘ç‡ Ï‰)", 360, 285);
            
            ctx.save();
            ctx.translate(20, 140);
            ctx.rotate(-Math.PI/2);
            ctx.fillText("|H|", 0, 0);
            ctx.restore();

            // å†å²æ›²çº¿ (å¹³æ»‘)
            ctx.beginPath();
            ctx.moveTo(50, 260);
            for(let i=0; i<spectrumHistory.length; i++) {
                let x = 50 + (i/spectrumHistory.length) * 330;
                let y = 260 - spectrumHistory[i] * 1.5;
                ctx.lineTo(x, y);
            }
            ctx.lineTo(380, 260);
            ctx.fillStyle = "rgba(142, 68, 173, 0.25)"; 
            ctx.fill();
            ctx.strokeStyle = "#8e44ad";
            ctx.lineWidth = 2;
            ctx.stroke();

            // å½“å‰çº¢ç‚¹
            if (isRunning) {
                let progress = frameCount / totalDuration;
                if(progress > 1) progress = 1;
                
                let currFreq = startFreq + (endFreq - startFreq) * progress;
                let cx = 50 + currFreq * 330;
                let amp = 100 * Math.exp(-2.5 * progress); 
                let cy = 260 - amp * 1.5;

                if (amp > 1) {
                    // ç‚¹
                    ctx.beginPath(); ctx.arc(cx, cy, 7, 0, Math.PI*2);
                    ctx.fillStyle = "#c0392b"; ctx.fill();
                    // è™šçº¿
                    ctx.beginPath(); ctx.moveTo(cx, 260); ctx.lineTo(cx, cy);
                    ctx.strokeStyle = "#c0392b"; 
                    ctx.lineWidth = 1;
                    ctx.setLineDash([5,5]); ctx.stroke(); ctx.setLineDash([]);
                }
            }
        }

        // --- ä¸»å¾ªç¯ ---
        function loop() {
            // 1. é”¤å­åŠ¨ç”»
            let hammerAngle = Math.PI/4;
            if (hammerState === 1) { 
                let p = (frameCount % 10) / 10;
                hammerAngle = Math.PI/4 - p*0.8; 
                frameCount++;
                if (frameCount > 8) {
                    hammerState = 2;
                    isRunning = true;
                    frameCount = 0;
                    bellShake = 25; 
                    playDeepBellSound();
                }
            } else if (hammerState === 2) { 
                 hammerAngle = Math.PI/4;
            }

            // 2. ä¿¡å·è®¡ç®—
            if (isRunning) {
                frameCount++;
                let progress = frameCount / totalDuration;

                if (progress <= 1.0) {
                    // --- h[n] è§†è§‰æ³¢å½¢ç”Ÿæˆ (ä¿®æ­£ç‰ˆ) ---
                    // ä½¿ç”¨åŒé¢‘ç‡å åŠ æ¥åˆ¶é€ â€œå¹²æ¶‰â€æ•ˆæœï¼Œçœ‹èµ·æ¥æ›´çœŸå®
                    let freqBase = startFreq + (endFreq - startFreq) * progress;
                    
                    // æ¨¡æ‹Ÿèƒ½é‡æŒ‡æ•°è¡°å‡
                    let env = 90 * Math.exp(-2.8 * progress);
                    
                    // ç›¸ä½ç´¯åŠ  (ä¸¤ä¸ªç•¥å¾®ä¸åŒçš„é¢‘ç‡)
                    phase1 += freqBase * 0.5;
                    phase2 += freqBase * 0.55; // ç¬¬äºŒä¸ªé¢‘ç‡ç¨å¿«ï¼Œäº§ç”Ÿæ‹é¢‘
                    
                    // h[n] = ä¸¤ä¸ªæ³¢çš„å åŠ 
                    let val = env * (Math.sin(phase1) + 0.6 * Math.sin(phase2));
                    
                    waveBuffer.shift(); waveBuffer.push(val);

                    // --- é¢‘è°±æ™•æŸ“ ---
                    let centerIdx = Math.floor(freqBase * 400);
                    let brushWidth = 25; 
                    
                    for (let k = -brushWidth; k <= brushWidth; k++) {
                        let idx = centerIdx + k;
                        if (idx >= 0 && idx < 400) {
                            let weight = Math.exp(-(k*k)/(2*20)); 
                            let paintVal = env * weight;
                            if (paintVal > spectrumHistory[idx]) {
                                spectrumHistory[idx] = paintVal;
                            }
                        }
                    }

                    bellShake *= 0.98; 

                } else {
                    isRunning = false;
                    btn.disabled = false;
                    btn.innerText = "ğŸ”Š æ•²å‡»å¤§é’Ÿ (æ¼”ç¤ºå¼€å§‹)";
                    hammerState = 0;
                }
            }

            drawBellScene(bellCtx, bellShake, hammerAngle);
            drawTimeDomain(tCtx);
            drawFreqDomain(fCtx);

            requestAnimationFrame(loop);
        }

        // --- äº¤äº’ ---
        btn.onclick = () => {
            isRunning = false;
            hammerState = 1;
            frameCount = 0;
            phase1 = 0;
            phase2 = 0;
            waveBuffer.fill(0);
            spectrumHistory.fill(0);
            btn.disabled = true;
            btn.innerText = "æ¼”ç¤ºè¿›è¡Œä¸­...";
        };

        loop();

    </script>
</body>
</html>