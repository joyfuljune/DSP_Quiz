<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FIR æ»¤æ³¢å™¨è®¾è®¡ï¼šçª—å‡½æ•°æ³•æ·±åº¦å›¾è§£</title>
    
    <!-- 1. MathJax é…ç½® -->
    <script>
    window.MathJax = {
      tex: { 
          inlineMath: [['$', '$'], ['\\(', '\\)']], 
          displayMath: [['$$', '$$'], ['\\[', '\\]']]
      },
      options: {
        skipHtmlTags: ['script', 'noscript', 'style', 'textarea', 'pre']
      },
      startup: { typeset: true }
    };
    </script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>

    <style>
        :root {
            --primary: #2c3e50;
            --secondary: #2980b9;
            --accent: #e67e22;
            --success: #27ae60;
            --bg: #f5f7fa;
            --card-bg: #ffffff;
            --border: #e1e4e8;
        }

        body {
            font-family: "Segoe UI", "Microsoft YaHei", sans-serif;
            background-color: var(--bg);
            color: #333;
            margin: 0;
            padding-bottom: 60px;
            line-height: 1.6;
        }

        .container { max-width: 1000px; margin: 0 auto; padding: 20px; }

        header {
            background: linear-gradient(135deg, #2c3e50, #34495e);
            color: white;
            padding: 40px 20px;
            text-align: center;
            border-radius: 0 0 15px 15px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            margin-bottom: 30px;
        }
        header h1 { margin: 0; font-size: 2rem; }
        header p { color: #ecf0f1; opacity: 0.9; margin-top: 10px; }

        .section-title {
            border-left: 5px solid var(--secondary);
            padding-left: 12px;
            color: var(--primary);
            margin-top: 40px;
            margin-bottom: 20px;
        }

        .card {
            background: var(--card-bg);
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            margin-bottom: 25px;
            border: 1px solid var(--border);
        }

        /* --- äº¤äº’åŒºåŸŸæ ·å¼ --- */
        .viz-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        @media(max-width: 800px) { .viz-grid { grid-template-columns: 1fr; } }

        .plot-box {
            background: #fff;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 10px;
            position: relative;
        }
        .plot-title {
            font-size: 0.9rem; font-weight: bold; color: #555; margin-bottom: 5px; text-align: center;
            background: #f8f9fa; padding: 5px; border-radius: 4px;
        }
        canvas { width: 100%; display: block; }

        .controls-panel {
            background: #edf2f7;
            padding: 20px;
            border-radius: 8px;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            align-items: center;
        }
        
        input[type=range] { width: 100%; cursor: pointer; }
        select { padding: 8px; border-radius: 5px; border: 1px solid #ccc; width: 100%; }

        /* --- ç†è®ºå…¬å¼åŒº --- */
        .formula-box {
            background: #fdfdfd;
            border-left: 4px solid var(--accent);
            padding: 15px;
            overflow-x: auto;
            margin: 15px 0;
            font-size: 0.95rem;
        }

        .step-list { counter-reset: step; list-style: none; padding: 0; }
        .step-list li { position: relative; padding-left: 50px; margin-bottom: 20px; }
        .step-list li::before {
            counter-increment: step;
            content: counter(step);
            position: absolute; left: 0; top: 0;
            width: 35px; height: 35px;
            background: var(--secondary); color: white;
            border-radius: 50%; text-align: center; line-height: 35px;
            font-weight: bold;
        }
        .step-title { font-weight: bold; color: var(--primary); display: block; margin-bottom: 5px; }

        /* --- ç»¼åˆä¾‹é¢˜æ ·å¼ --- */
        .example-container {
            border: 2px dashed var(--secondary);
            background: #f0f8ff;
            padding: 25px;
            border-radius: 10px;
        }
        .spec-tag {
            display: inline-block;
            background: var(--primary);
            color: white;
            padding: 4px 10px;
            border-radius: 4px;
            font-size: 0.85rem;
            margin-right: 10px;
            margin-bottom: 10px;
        }

        /* åŠ¨ç”»æç¤º */
        @keyframes pulse { 0% { opacity: 0.6; } 50% { opacity: 1; } 100% { opacity: 0.6; } }
        .anim-hint { color: var(--accent); font-size: 0.8rem; animation: pulse 2s infinite; font-weight: bold; }

    </style>
</head>
<body>

<header>
    <h1>FIR æ»¤æ³¢å™¨è®¾è®¡ï¼šçª—å‡½æ•°æ³•</h1>
    <p>ä»ç†æƒ³çš„æ— é™é•¿ä¿¡å·ï¼Œåˆ°ç°å®çš„æœ‰é™é•¿æ»¤æ³¢å™¨</p>
</header>

<div class="container">

    <!-- ç¬¬ä¸€éƒ¨åˆ†ï¼šé€šä¿—è§£é‡Š -->
    <div class="card">
        <h2 class="section-title" style="margin-top:0;">ğŸ’¡ æ ¸å¿ƒåŸç†ï¼šä¸ºä»€ä¹ˆéœ€è¦â€œçª—â€ï¼Ÿ</h2>
        <p>
            æƒ³è±¡ä½ è¦åˆ¶ä½œä¸€ä¸ªå®Œç¾çš„åœ†å½¢é¥¼å¹²ï¼ˆç†æƒ³æ»¤æ³¢å™¨ï¼‰ï¼Œä½†ä½ çš„é¢å›¢æ˜¯æ— é™å¤§çš„ï¼ˆæ— é™é•¿çš„ $h_d[n]$ï¼‰ã€‚
            ä½ éœ€è¦ç”¨ä¸€ä¸ª<strong>é¥¼å¹²æ¨¡å…·ï¼ˆçª—å‡½æ•°ï¼‰</strong>æŠŠå®ƒæˆªæ–­ï¼Œæ‰èƒ½æ”¾è¿›çƒ¤ç®±ï¼ˆè®¡ç®—æœºï¼‰é‡Œå¤„ç†ã€‚
        </p>
        <div style="display: flex; gap: 20px; flex-wrap: wrap; background: #fff8e1; padding: 15px; border-radius: 8px;">
            <div style="flex: 1; min-width: 250px;">
                <strong>1. ç†æƒ³çŠ¶æ€ (The Dream)</strong><br>
                é¢‘åŸŸæ˜¯å®Œç¾çš„çŸ©å½¢ï¼ˆå¢™ï¼‰ã€‚<br>
                æ—¶åŸŸæ˜¯æ— é™é•¿çš„ $\text{sinc}$ å‡½æ•°ã€‚
            </div>
            <div style="flex: 0 0 20px; text-align: center; font-weight: bold; padding-top:10px;">âœ–</div>
            <div style="flex: 1; min-width: 250px;">
                <strong>2. ç°å®æ‰‹æ®µ (The Window)</strong><br>
                æˆ‘ä»¬åªèƒ½ä¿ç•™ä¸€æ®µ N ä¸ªç‚¹ã€‚<br>
                ç›¸å½“äºä¹˜ä»¥ä¸€ä¸ªâ€œçª—å‡½æ•°â€ $w[n]$ã€‚
            </div>
            <div style="flex: 0 0 20px; text-align: center; font-weight: bold; padding-top:10px;">=</div>
            <div style="flex: 1; min-width: 250px;">
                <strong>3. æœ€ç»ˆç»“æœ (The Reality)</strong><br>
                æ—¶åŸŸå˜æœ‰é™äº†ã€‚<br>
                <strong>ä»£ä»·ï¼š</strong>é¢‘åŸŸè¾¹ç¼˜å‡ºç°äº†â€œè¤¶çš±â€ï¼ˆå‰å¸ƒæ–¯ç°è±¡ï¼‰ï¼Œè¿‡æ¸¡å¸¦å˜å®½ã€‚
            </div>
        </div>
    </div>

    <!-- ç¬¬äºŒéƒ¨åˆ†ï¼šäº¤äº’å¼å®éªŒå®¤ -->
    <div class="card">
        <div style="display: flex; justify-content: space-between; align-items: center;">
            <h2 class="section-title" style="margin-top:0;">ğŸ› ï¸ äº¤äº’å®éªŒå®¤ï¼šæ‰€è§å³æ‰€å¾—</h2>
            <span class="anim-hint">â† è°ƒæ•´å‚æ•°ï¼Œå®æ—¶è§‚å¯Ÿé¢‘è°±å˜åŒ–</span>
        </div>
        
        <!-- æ§åˆ¶é¢æ¿ -->
        <div class="controls-panel">
            <div>
                <label><strong>çª—å‡½æ•°ç±»å‹ (Window Type)</strong></label>
                <select id="selWindow" onchange="updateSim()">
                    <option value="rect">çŸ©å½¢çª— (Rectangular) - æˆªæ­¢æœ€å¿«ï¼Œçº¹æ³¢æœ€å¤§</option>
                    <option value="hamming" selected>æ±‰æ˜çª— (Hamming) - ç»å…¸å¹³è¡¡</option>
                    <option value="blackman">å¸ƒè±å…‹æ›¼çª— (Blackman) - é˜»å¸¦è¡°å‡æä½³</option>
                    <option value="hanning">æ±‰å®çª— (Hanning)</option>
                </select>
            </div>
            <div>
                <label><strong>æ»¤æ³¢å™¨é•¿åº¦ N: <span id="dispN">31</span></strong></label>
                <input type="range" id="rngN" min="11" max="101" step="2" value="31" oninput="updateSim()">
            </div>
            <div>
                <label><strong>æˆªæ­¢é¢‘ç‡ $\omega_c / \pi$: <span id="dispWc">0.4</span></strong></label>
                <input type="range" id="rngWc" min="0.1" max="0.9" step="0.05" value="0.4" oninput="updateSim()">
            </div>
        </div>

        <div style="margin-top: 20px;"></div>

        <!-- ç»˜å›¾ç½‘æ ¼ -->
        <div class="viz-grid">
            <!-- æ—¶åŸŸï¼šç†æƒ³ vs æˆªæ–­ -->
            <div class="plot-box">
                <div class="plot-title">æ—¶åŸŸï¼š$h_{ideal}[n]$ (ç°) $\times$ $w[n]$ (ç»¿) = $h[n]$ (è“)</div>
                <canvas id="timeCanvas" height="250"></canvas>
            </div>
            
            <!-- é¢‘åŸŸï¼šå¹…åº¦å“åº” -->
            <div class="plot-box">
                <div class="plot-title">é¢‘åŸŸï¼šå¹…åº¦å“åº” $20\log|H(e^{j\omega})|$ (dB)</div>
                <canvas id="freqCanvas" height="250"></canvas>
            </div>
        </div>
        
        <div style="font-size: 0.9rem; color: #666; margin-top: 10px; background: #eee; padding: 10px; border-radius: 5px;">
            <strong>è§‚å¯Ÿé‡ç‚¹ï¼š</strong>
            1. <strong>çŸ©å½¢çª—</strong>çš„è¿‡æ¸¡å¸¦å¾ˆçª„ï¼Œä½†åœ¨é˜»å¸¦æœ‰å¾ˆå¤šæ³¢çº¹ï¼ˆè¡°å‡å·®ï¼‰ã€‚<br>
            2. åˆ‡æ¢åˆ° <strong>Blackmançª—</strong>ï¼Œä¸»ç“£å˜å®½ï¼ˆè¿‡æ¸¡å¸¦å˜å®½ï¼‰ï¼Œä½†é˜»å¸¦è¡°å‡éå¸¸æ·±ï¼ˆæ³¢çº¹æ¶ˆå¤±ï¼‰ã€‚<br>
            3. å¢åŠ é•¿åº¦ <strong>N</strong>ï¼Œè¿‡æ¸¡å¸¦ä¼šå˜é™¡å³­ã€‚
        </div>
    </div>

    <!-- ç¬¬ä¸‰éƒ¨åˆ†ï¼šè®¾è®¡æ­¥éª¤ä¸å…¬å¼ -->
    <div class="card">
        <h2 class="section-title">ğŸ“š è¯¦ç»†è®¾è®¡æ­¥éª¤</h2>

        <ul class="step-list">
            <li>
                <span class="step-title">ç¡®å®šæŒ‡æ ‡</span>
                æ˜ç¡®é€šå¸¦é¢‘ç‡ $\omega_p$ã€é˜»å¸¦é¢‘ç‡ $\omega_s$ ä»¥åŠæ‰€éœ€çš„é˜»å¸¦è¡°å‡ $A_s$ (dB)ã€‚<br>
                è®¡ç®—è¿‡æ¸¡å¸¦å®½åº¦ï¼š$\Delta \omega = |\omega_s - \omega_p|$ã€‚
                <br>è®¡ç®—ç†æƒ³æˆªæ­¢é¢‘ç‡ï¼š$\omega_c = (\omega_p + \omega_s) / 2$ã€‚
            </li>
            <li>
                <span class="step-title">é€‰æ‹©çª—å‡½æ•°</span>
                æ ¹æ®<strong>é˜»å¸¦è¡°å‡ $A_s$</strong> çš„è¦æ±‚é€‰æ‹©çª—å‡½æ•°ã€‚è¿™æ˜¯ç¡¬æŒ‡æ ‡ï¼Œä¸èƒ½å¦¥åã€‚
                <div class="formula-box" style="margin-top: 5px;">
                    <table style="width:100%; border-collapse: collapse;">
                        <tr style="border-bottom: 1px solid #ccc;"><th style="text-align:left">çª—ç±»å‹</th><th>æœ€å°é˜»å¸¦è¡°å‡</th><th>è¿‡æ¸¡å¸¦è¿‘ä¼¼å®½åº¦</th></tr>
                        <tr><td>çŸ©å½¢ (Rect)</td><td>-21 dB</td><td>$1.8\pi / N$</td></tr>
                        <tr><td>æ±‰å® (Hanning)</td><td>-44 dB</td><td>$6.2\pi / N$</td></tr>
                        <tr style="background:#eaf2f8"><td><strong>æ±‰æ˜ (Hamming)</strong></td><td><strong>-53 dB</strong></td><td><strong>$6.6\pi / N$</strong></td></tr>
                        <tr><td>å¸ƒè±å…‹æ›¼ (Blackman)</td><td>-74 dB</td><td>$11\pi / N$</td></tr>
                    </table>
                </div>
            </li>
            <li>
                <span class="step-title">è®¡ç®—é˜¶æ•° N</span>
                æ ¹æ®ä¸Šè¡¨ä¸­çš„â€œè¿‡æ¸¡å¸¦è¿‘ä¼¼å®½åº¦â€å…¬å¼åæ¨ $N$ã€‚<br>
                ä¾‹å¦‚å¯¹äºæ±‰æ˜çª—ï¼š$N \approx \frac{6.6\pi}{\Delta \omega}$ã€‚<br>
                <em>æç¤ºï¼šä¸ºäº†ä¿è¯å¯¹ç§°æ€§ï¼ˆType Iï¼‰ï¼Œé€šå¸¸å– N ä¸ºå¥‡æ•°ã€‚</em>
            </li>
            <li>
                <span class="step-title">è®¡ç®—æ»¤æ³¢å™¨ç³»æ•°</span>
                åˆ©ç”¨å…¬å¼ï¼š
                $$ h[n] = h_{ideal}[n - \alpha] \cdot w[n] $$
                å…¶ä¸­ $\alpha = (N-1)/2$ æ˜¯å»¶è¿Ÿä¸­å¿ƒã€‚å¯¹äºä½é€šæ»¤æ³¢å™¨ï¼Œç†æƒ³è„‰å†²å“åº”ä¸ºï¼š
                $$ h_{ideal}[n] = \frac{\sin[\omega_c (n-\alpha)]}{\pi (n-\alpha)} $$
                (å½“ $n=\alpha$ æ—¶ï¼Œå€¼ä¸º $\omega_c/\pi$)
            </li>
        </ul>
    </div>

    <!-- ç¬¬å››éƒ¨åˆ†ï¼šç»¼åˆä¾‹é¢˜ -->
    <div class="example-container">
        <h2 style="margin-top:0; color: #2c3e50;">ğŸ“ ç»¼åˆä¾‹é¢˜ï¼šä¼ æ„Ÿå™¨å™ªå£°æ»¤é™¤</h2>
        <p><strong>åœºæ™¯ï¼š</strong> ä¸€ä¸ªé‡‡æ ·ç‡ä¸º $F_s = 2000 \text{ Hz}$ çš„ç³»ç»Ÿï¼Œéœ€è¦è®¾è®¡ä¸€ä¸ªä½é€šæ»¤æ³¢å™¨æ»¤é™¤ $500 \text{ Hz}$ ä»¥ä¸Šçš„é«˜é¢‘å™ªå£°ï¼Œè¦æ±‚åœ¨ $400 \text{ Hz}$ å¤„è¡°å‡ä¸è¶…è¿‡ 3dBï¼Œåœ¨ $600 \text{ Hz}$ å¤„è‡³å°‘è¡°å‡ <strong>50 dB</strong>ã€‚</p>

        <div style="margin-bottom: 15px;">
            <span class="spec-tag">Fs = 2000 Hz</span>
            <span class="spec-tag">Fp = 400 Hz</span>
            <span class="spec-tag">Fs_stop = 600 Hz</span>
            <span class="spec-tag">As >= 50 dB</span>
        </div>

        <h3 style="color:var(--secondary)">Step 1: å½’ä¸€åŒ–é¢‘ç‡</h3>
        <div class="formula-box">
            $$ \omega_p = 2\pi \frac{400}{2000} = 0.4\pi $$
            $$ \omega_s = 2\pi \frac{600}{2000} = 0.6\pi $$
            $$ \omega_c = \frac{0.4\pi + 0.6\pi}{2} = 0.5\pi \quad (\text{ç†æƒ³æˆªæ­¢é¢‘ç‡}) $$
            $$ \Delta\omega = \omega_s - \omega_p = 0.2\pi \quad (\text{è¿‡æ¸¡å¸¦å®½åº¦}) $$
        </div>

        <h3 style="color:var(--secondary)">Step 2: é€‰æ‹©çª—å‡½æ•°</h3>
        <p>
            éœ€æ±‚æ˜¯é˜»å¸¦è¡°å‡ $\ge 50 \text{ dB}$ã€‚<br>
            æŸ¥è¡¨å¯çŸ¥ï¼š
            <ul>
                <li>Hanning (-44 dB) <span style="color:red">ä¸å¤Ÿ</span></li>
                <li>Hamming (-53 dB) <span style="color:green">æ»¡è¶³ï¼Œä¸”è¿‡æ¸¡å¸¦è¾ƒçª„ï¼Œé¦–é€‰</span></li>
                <li>Blackman (-74 dB) <span style="color:green">æ»¡è¶³ï¼Œä½†é˜¶æ•°ä¼šæ›´é«˜</span></li>
            </ul>
            <strong>å†³å®šï¼šä½¿ç”¨ Hamming çª—ã€‚</strong>
        </p>

        <h3 style="color:var(--secondary)">Step 3: è®¡ç®—é•¿åº¦ N</h3>
        <div class="formula-box">
            Hamming çª—è¿‡æ¸¡å¸¦å…¬å¼ï¼š $\Delta\omega \approx \frac{6.6\pi}{N}$
            $$ N \ge \frac{6.6\pi}{0.2\pi} = 33 $$
            å–å¥‡æ•° $N = 33$ã€‚å› æ­¤é˜¶æ•° $M = N-1 = 32$ï¼Œå»¶è¿Ÿ $\alpha = 16$ã€‚
        </div>

        <h3 style="color:var(--secondary)">Step 4: æœ€ç»ˆè¡¨è¾¾å¼</h3>
        <p>è®¾è®¡å®Œæˆï¼æ»¤æ³¢å™¨ç³»æ•° $h[n]$ (å¯¹äº $0 \le n \le 32$) ä¸ºï¼š</p>
        <div class="formula-box">
            $$ h[n] = \frac{\sin[0.5\pi (n-16)]}{\pi (n-16)} \cdot \left( 0.54 - 0.46 \cos\left( \frac{2\pi n}{32} \right) \right) $$
        </div>
        <button onclick="loadExample()" style="background: var(--accent); color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; font-size: 1rem; margin-top: 10px;">
            ğŸš€ ç‚¹å‡»æ­¤å¤„ï¼šå°†æ­¤ä¾‹é¢˜å‚æ•°åŠ è½½åˆ°ä¸Šæ–¹å®éªŒå®¤
        </button>
    </div>

</div>

<script>
    // ==========================================
    // ä¿¡å·å¤„ç†æ ¸å¿ƒé€»è¾‘
    // ==========================================
    
    // è¾…åŠ©å‡½æ•°ï¼šSinc
    function sinc(x) {
        if (Math.abs(x) < 1e-8) return 1;
        return Math.sin(Math.PI * x) / (Math.PI * x);
    }

    // çª—å‡½æ•°ç”Ÿæˆå™¨
    const Windows = {
        rect: (n, N) => 1,
        hamming: (n, N) => 0.54 - 0.46 * Math.cos(2 * Math.PI * n / (N - 1)),
        hanning: (n, N) => 0.5 - 0.5 * Math.cos(2 * Math.PI * n / (N - 1)),
        blackman: (n, N) => 0.42 - 0.5 * Math.cos(2 * Math.PI * n / (N - 1)) + 0.08 * Math.cos(4 * Math.PI * n / (N - 1))
    };

    // çŠ¶æ€
    let state = {
        N: 31,
        wc_pi: 0.4, // wc / pi
        winType: 'hamming'
    };

    function updateState() {
        state.N = parseInt(document.getElementById('rngN').value);
        // å¼ºåˆ¶å¥‡æ•°ä»¥ä¾¿æ•™å­¦ (Type I)
        if(state.N % 2 === 0) state.N += 1;
        
        state.wc_pi = parseFloat(document.getElementById('rngWc').value);
        state.winType = document.getElementById('selWindow').value;

        document.getElementById('dispN').innerText = state.N;
        document.getElementById('dispWc').innerText = state.wc_pi.toFixed(2);
    }

    // æ ¸å¿ƒè®¡ç®—
    function calculateFilter() {
        const h = [];
        const w = [];
        const h_ideal = [];
        const alpha = (state.N - 1) / 2;
        
        for (let n = 0; n < state.N; n++) {
            // 1. ç†æƒ³ Sinc (æ³¨æ„ sinc å‡½æ•°å®šä¹‰é€šå¸¸å«piï¼Œè¿™é‡Œæ‰‹åŠ¨å¤„ç†)
            // h_ideal[n] = sin(wc * (n-alpha)) / (pi*(n-alpha))
            // let x = (n - alpha);
            // let val = (x === 0) ? state.wc_pi : Math.sin(state.wc_pi * Math.PI * x) / (Math.PI * x);
            
            // ä½¿ç”¨å½’ä¸€åŒ– sinc: sinc(x) = sin(pi*x)/(pi*x)
            // å…¬å¼: (wc/pi) * sinc((wc/pi)*(n-alpha)) ? No.
            // æ ‡å‡†ä½é€š: sin(wc*(n-a))/(pi*(n-a))
            
            let val_ideal;
            let offset = n - alpha;
            if (Math.abs(offset) < 1e-9) {
                val_ideal = state.wc_pi;
            } else {
                val_ideal = Math.sin(state.wc_pi * Math.PI * offset) / (Math.PI * offset);
            }
            h_ideal.push(val_ideal);

            // 2. çª—å‡½æ•°
            let val_win = Windows[state.winType](n, state.N);
            w.push(val_win);

            // 3. å®é™…ç³»æ•°
            h.push(val_ideal * val_win);
        }
        return { h, w, h_ideal };
    }

    // DFT è®¡ç®—å¹…åº¦å“åº” (dB)
    function calculateFreqResponse(h, points = 512) {
        const mags = [];
        for (let k = 0; k < points; k++) {
            let omega = Math.PI * k / points; // 0 to pi
            let re = 0, im = 0;
            for (let n = 0; n < h.length; n++) {
                re += h[n] * Math.cos(omega * n);
                im -= h[n] * Math.sin(omega * n);
            }
            let mag = Math.sqrt(re*re + im*im);
            // å½’ä¸€åŒ–
            // mag = mag; 
            mags.push(mag);
        }
        
        // å½’ä¸€åŒ–æœ€å¤§å€¼ä¸º 0dB
        let maxVal = Math.max(...mags);
        if(maxVal < 1e-9) maxVal = 1;

        return mags.map(m => {
            let db = 20 * Math.log10(m / maxVal + 1e-9); // é˜²æ­¢ log(0)
            return Math.max(db, -100); // æˆªæ–­åº•éƒ¨
        });
    }

    // ==========================================
    // ç»˜å›¾é€»è¾‘
    // ==========================================
    function drawTime(data) {
        const cvs = document.getElementById('timeCanvas');
        const ctx = cvs.getContext('2d');
        const W = cvs.width = cvs.clientWidth;
        const H = cvs.height = cvs.clientHeight;
        
        ctx.clearRect(0,0,W,H);
        
        const padding = 30;
        const plotW = W - padding*2;
        const plotH = H - padding*2;
        const zeroY = H/2;
        
        // æ‰¾å‡ºæœ€å¤§å€¼ä»¥ä¾¿ç¼©æ”¾
        const maxVal = Math.max(...data.h_ideal.map(Math.abs), 1.0) * 1.1;
        const scaleY = (plotH / 2) / maxVal;
        const stepX = plotW / (state.N - 1);

        // ç»˜åˆ¶åæ ‡è½´
        ctx.beginPath(); ctx.strokeStyle = '#eee';
        ctx.moveTo(padding, zeroY); ctx.lineTo(W-padding, zeroY);
        ctx.stroke();

        // 1. ç»˜åˆ¶ç†æƒ³ (ç°è‰²è™šçº¿ + ç»†ç‚¹)
        ctx.fillStyle = '#ccc';
        for(let i=0; i<state.N; i++) {
            let x = padding + i*stepX;
            let y = zeroY - data.h_ideal[i]*scaleY;
            ctx.beginPath(); ctx.arc(x,y,2,0,2*Math.PI); ctx.fill();
        }

        // 2. ç»˜åˆ¶çª— (ç»¿è‰²è½®å»“)
        ctx.strokeStyle = 'rgba(39, 174, 96, 0.3)'; ctx.lineWidth = 2;
        ctx.beginPath();
        for(let i=0; i<state.N; i++) {
            let x = padding + i*stepX;
            let y = zeroY - data.w[i]*scaleY; // çª—é€šå¸¸æ˜¯æ­£çš„ï¼Œä½†ä¹Ÿå¯èƒ½ç”»åœ¨ä¸Šæ–¹
            // ä¸ºäº†ç›´è§‚ï¼Œæˆ‘ä»¬æŠŠçª—ç”»åœ¨ä¸Šæ–¹èƒŒæ™¯é‡Œ
            y = H - padding - data.w[i] * (plotH/2.5); 
            if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
        }
        ctx.stroke();
        ctx.fillStyle = '#27ae60'; ctx.font="10px Arial"; ctx.fillText("Window Shape", padding, H-padding-5);

        // 3. ç»˜åˆ¶æœ€ç»ˆ h[n] (è“è‰² Stem)
        for(let i=0; i<state.N; i++) {
            let x = padding + i*stepX;
            let y = zeroY - data.h[i]*scaleY;
            
            ctx.beginPath(); ctx.strokeStyle = '#2980b9'; ctx.lineWidth = 2;
            ctx.moveTo(x, zeroY); ctx.lineTo(x, y); ctx.stroke();
            
            ctx.beginPath(); ctx.fillStyle = '#2980b9';
            ctx.arc(x, y, 3, 0, Math.PI*2); ctx.fill();
        }
    }

    function drawFreq(dbData) {
        const cvs = document.getElementById('freqCanvas');
        const ctx = cvs.getContext('2d');
        const W = cvs.width = cvs.clientWidth;
        const H = cvs.height = cvs.clientHeight;
        
        ctx.clearRect(0,0,W,H);
        
        const paddingLeft = 40;
        const paddingBottom = 30;
        const plotW = W - paddingLeft - 20;
        const plotH = H - paddingBottom - 20;
        
        // dB Range: 0 to -100
        const minDB = -100;
        
        // ç»˜åˆ¶ç½‘æ ¼
        ctx.strokeStyle = '#f0f0f0'; ctx.lineWidth = 1;
        // dB grid
        ctx.fillStyle = '#999'; ctx.font = '10px Arial'; ctx.textAlign = 'right';
        for(let db=0; db >= minDB; db-=20) {
            let y = 20 + (db / minDB) * plotH * -1; // 0 at top (20), -100 at bottom
            y = 20 + (0 - db)/(0 - minDB) * plotH; 
            
            ctx.beginPath(); ctx.moveTo(paddingLeft, y); ctx.lineTo(W, y); ctx.stroke();
            ctx.fillText(db, paddingLeft - 5, y + 3);
        }
        
        // Freq Grid
        ctx.textAlign = 'center';
        const labels = ["0", "0.2Ï€", "0.4Ï€", "0.6Ï€", "0.8Ï€", "Ï€"];
        for(let i=0; i<labels.length; i++) {
            let x = paddingLeft + (i / 5) * plotW;
            ctx.beginPath(); ctx.moveTo(x, 20); ctx.lineTo(x, 20+plotH); ctx.stroke();
            ctx.fillText(labels[i], x, H - 10);
        }

        // ç»˜åˆ¶æ›²çº¿
        ctx.beginPath();
        ctx.strokeStyle = '#e74c3c'; ctx.lineWidth = 2;
        for(let i=0; i<dbData.length; i++) {
            let x = paddingLeft + (i / (dbData.length-1)) * plotW;
            let db = dbData[i];
            let y = 20 + (0 - db)/(0 - minDB) * plotH;
            if (i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
        }
        ctx.stroke();

        // æ ‡è®°æˆªæ­¢é¢‘ç‡
        let xWc = paddingLeft + state.wc_pi * plotW;
        ctx.strokeStyle = '#2c3e50'; ctx.setLineDash([5,5]);
        ctx.beginPath(); ctx.moveTo(xWc, 20); ctx.lineTo(xWc, 20+plotH); ctx.stroke();
        ctx.setLineDash([]);
        ctx.fillStyle = '#2c3e50';
        ctx.fillText("Ï‰c", xWc, 15);
    }

    // ä¸»æ›´æ–°å‡½æ•°
    function updateSim() {
        updateState();
        const data = calculateFilter();
        const freqData = calculateFreqResponse(data.h);
        
        drawTime(data);
        drawFreq(freqData);
    }

    // åŠ è½½ä¾‹é¢˜
    function loadExample() {
        document.getElementById('selWindow').value = 'hamming';
        document.getElementById('rngN').value = 33;
        document.getElementById('rngWc').value = 0.5;
        updateSim();
        
        // æ»šåŠ¨åˆ°é¡¶éƒ¨
        document.querySelector('.controls-panel').scrollIntoView({behavior: 'smooth'});
    }

    // åˆå§‹åŒ–
    window.onload = updateSim;
    window.addEventListener('resize', updateSim);

</script>

</body>
</html>